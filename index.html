<!DOCTYPE html>
<meta charset="utf-8">
<style>

.node {
  stroke: #fff;
  stroke-width: 1.5px;
}

.link {
  stroke: #999;
  stroke-opacity: .6;
   
}

rect.selection {
  fill: transparent;
  stroke-dasharray: 3px;
  stroke: black;
  stroke-width: 2px;
}
 
 
.selected {
   stroke: blue;
   stroke-width: 5;
   stroke-dasharray: 3;
}

#completeGraph {

  float:left;
}

</style>


<body>




<p>Select Graph: </p>


<select name="graphsChoice" id="graphChoice" onchange="loadGraph()" selectedIndex = "1">
<option value="data/example1.json">example1</option>
<option value="data/example2.json">example2</option>
<option value="data/example3.json">example3</option>
<option value="data/example4.json">example4</option>
</select>
<button onclick="partition()" value = "off" id = "partitionButton">Partition</button>


<p id="loadGraph"></p>


<p id="reinitialization"></p>
<p id="walk"> </p>
<p  id = "partition" ></p>

<div id = "completeGraph"></div>




<p>

  <label for="time" 
         style="display: inline-block; width: 240px; text-align: right">
         Time = <span id="time-value">0</span>
  </label>
  <input type="range" min="0" max="150" id="time">
</p>
<button onclick="walk()">Walk</button>
<button onclick="reinitialization()">Reinitialization</button>


<script src="lib/d3.min.js"></script>
<script src ="lib/math.js"></script>
<script src ="lib/numeric.min.js"></script>
<script src ="lib/ryb-color-mixer.js"></script>

<script src ="loadJSON.js"></script>
<script src ="readUserGraph.js"></script>
<script src ="graph.js"></script>
<script src = "partition.js"></script>



<script>

var NB_MAX_COLOR = 10;
var nbColor = 3;
var nbWalkerTot = nbColor*100;
var groupNode = []; //Array containing the nodes selected
var color = d3.scale.category20(); //Array of random color


var circles = null, lines = null, graph = null;

var width = 600,
    height = 500;
    
var force = d3.layout.force()
    .charge(-1000)
    .linkDistance(75)
    .size([width, height]);


var svg = d3.select("#completeGraph").append("svg")
    .attr("width", width)
    .attr("height", height);
    
var svg2 = d3.select("#partitionGraph").append("svg")
    .attr("width", width)
    .attr("height", height);

var currColor = "#ff0000";

svg.append("rect")
  .attr("class", "colorChoice")
  .attr("width", 50)
  .attr("height", 50)
  .attr("fill", "red")
  .attr("x", 5)
  .attr("y", 5)
  .attr("rx", 15) // rounded corner
  .attr("ry", 15)
  .on("click", function() {
    currColor = "#ff0000";
    
    svg.selectAll(".colorChoice")
      .style("stroke-width", "0");
    d3.select(this).style("stroke", "#000000");
    d3.select(this).style("stroke-width", "3");
  });

svg.append("rect")
  .attr("class", "colorChoice")
  .attr("width", 50)
  .attr("height", 50)
  .attr("fill", "yellow")
  .attr("x", 65)
  .attr("y", 5)
  .attr("rx", 15)
  .attr("ry", 15)
  .on("click", function() {
    currColor = "#00ff00";
    
    svg.selectAll(".colorChoice")
      .style("stroke-width", "0");
    
    d3.select(this).style("stroke", "#000000");
    d3.select(this).style("stroke-width", "3");

    

  });
svg.append("rect")
  .attr("class", "colorChoice")
  .attr("width", 50)
  .attr("height", 50)
  .attr("fill", "blue")
  .attr("x", 125)
  .attr("y", 5)
  .attr("rx", 15)
  .attr("ry", 15)
  .on("click", function() {
    currColor = "#0000ff";
    
    svg.selectAll(".colorChoice")
      .style("stroke-width", "0");
    d3.select(this).style("stroke", "#000000");
    d3.select(this).style("stroke-width", "3");
  });


d3.select("#time").property("value", 0);
d3.select("#graphChoice").property("selectedIndex", 0);
d3.select("#time").on("input", function() {
  
  step = +this.value;
  walk();
});


var step = 0;
var initialNodeisClicked = false;

loadGraph("data/example1.json");



function walk() {
  
  d3.select("#time-value").text(step);
  d3.select("#time").property("value", step);


  var Xn = [];
  for( var i = 0; i < nbColor; i++) {
    Xn[i] = math.multiply(graph.X0[i], math.pow(graph.P, step));
  }
  
  for(var i = 0; i < nbColor; i++) {
    for(var j = 0; j < graph.nodes.length; j++) {
      graph.nodes[j].nbWalkers[i] = Xn[i].subset(math.index(j));
    }

  }
  
  step++;
  update();
  
}

function update() {

  if(node != null) {

    node
      .transition()
      .attr("r", function(d) {return (d.nbWalker/nbWalkerTot)* 60 + 25})
      .style("fill", function(d) { 
        var rybColor = [];
        for(var i = 0; i < nbColor; i++) {
          rybColor[i] = 255/100 * d.nbWalkers[i]; //
        }
        return "#" +(rybColorMixer.rybToRgb(rybColor, { hex: true}));
      })	
    node
      .attr("title", function(d) { return d.nbWalker});
  }

}

function reinitialization() {
  
  step = 1;
 
  
  for(var i = 0; i < graph.nodes.length; i++) {
    graph.nodes[i].nbWalker = graph.X0[i];
    

  }
  
  
  update();  
}
</script>



