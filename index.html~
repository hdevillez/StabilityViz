<!DOCTYPE html>
<meta charset="utf-8">
<style>

.node {
  stroke: #fff;
  stroke-width: 1.5px;
}

.link {
  stroke: #999;
  stroke-opacity: .6;
   
}

rect.selection {
  fill: transparent;
  stroke-dasharray: 3px;
  stroke: black;
  stroke-width: 2px;
}
 
 
.selected {
   stroke: blue;
   stroke-width: 5;
   stroke-dasharray: 3;
}

.active {
  border:3px solid grey; 
  background-color: grey;
  color: white; 
}

.menu {
  float:up;
}

.slideBox {
  width : 49%; height : 550px;
  border:2px solid black;
  border-radius: 25px;
}
.slider {
  width: 100%; height: 500px;
  overflow: hidden;

}

.slider > ul {
  /* styled by JS to match the added width and height of all <li>â€™s */
  position: relative;
  -webkit-transition: 0.5s left;
  -moz-transition: 0.5s left;
  -ms-transition: 0.5s left;
  -o-transition: 0.5s left;
     
  list-style: none;
  margin: 0; padding: 0;
}

.slider > ul > li {
  float: left;
  width: 50%; height: 500px;
}


</style>


<body style ="background: #B0C4DE">
<div class="menu">
  <select name="graphsChoice" id="graphChoice" onchange="loadGraph()" selectedIndex = "1">
  <option value="data/example1.json">example1</option>
  <option value="data/example2.json">example2</option>
  <option value="data/example3.json">example3</option>
  <option value="data/example4.json">example4</option>
  <option value="data/example5.json">example5</option>
  </select>
  <button onclick="partition()" value = "off" id = "partitionButton">Partition</button>
  <button onclick="start()" value = "off" id = "startButton">Start</button>
  <button onclick="reinitialization()">Reinitialization</button>
  <button onclick="showEmptyBarChart()" id = "showBarChartButton" disabled="true" autocomplete="off">Show Bar Chart</button>


</div>
<div class = "slideBox" style = "float:left">
  <div class="slider">
    <ul id ="graphSlide">
      <li><div id = "visGraph1"></li>
      <li><div id = "visGraph2"></li>
      <li><div id = "visGraph3"></li>
      <li><div id = "visGraph4"></li>
   </ul>
  </div>
  
  
  <button onclick="sliders[0].goToPrev()" style="float:left">Prev</button>
  <button onclick="sliders[0].goToNext()" style="float:right">Next</button>

</div>

<div class = "slideBox" style = "float:right">
  
  <div class ="slider">
    <ul id ="sideSlide">
      <li><div id = "visSide1"></li>
      <li><div id = "visSide2"></li>
      <li><div id = "visSide3"></li>
      <li><div id = "visSide4"></li>
    </ul>
  </div>

    <button onclick="sliders[1].goToPrev()" style="float:left">Prev</button>
    <button onclick="sliders[1].goToNext()" style="float:right">Next</button>
</div>


<p>

  <label for="time" 
         style="display: inline-block; width: 120px; text-align: left;">
         Time = <span id="time-value">0</span>
  </label>
  <input type="range" min="0" max="150" id="time" disabled="true" autocomplete="off">
</p>

<button onclick="walk(time+getSpeedWalk())" id = "walkButton" disabled="true" autocomplete="off">Walk</button>
<button onclick="automaticWalk()" id = "automaticWalkButton" disabled="true" autocomplete="off">Automatic Walk</button>
<p>Speed :
<button onclick="setSpeedWalk(1)" id = "setSpeedWalkButton1" disabled="true" autocomplete="off">1</button>
<button onclick="setSpeedWalk(2)" id = "setSpeedWalkButton2" disabled="true" autocomplete="off">2</button>
<button onclick="setSpeedWalk(3)" id = "setSpeedWalkButton3" disabled="true" autocomplete="off">3</button>
</p>





<script src="lib/d3.min.js"></script>
<script src ="lib/math.js"></script>
<script src ="lib/numeric.min.js"></script>
<script src ="lib/ryb-color-mixer.js"></script>


<script src ="loadJSON.js"></script>
<script src ="readUserGraph.js"></script>
<script src ="graph.js"></script>
<script src ="partition.js"></script>
<script src ="barChart.js"></script>
<script src ="slider.js"></script>
<script src ="slideshow.js"></script>



<script>

var NB_MAX_COLOR = 10;
var nbColor = 3;
var nbWalkerTot = 0;
var groupNode = []; //Array containing the nodes selected
var color = d3.scale.category20(); //Array of random color


var circles = null, lines = null, graph = null;

var force = d3.layout.force()
    .charge(-1000)
    .linkDistance(75)
    .size([width, height]);



var currColor = "#ff0000";

svg.append("rect")
  .attr("class", "colorChoice")
  .attr("width", 50)
  .attr("height", 50)
  .attr("fill", "red")
  .attr("x", 5)
  .attr("y", 5)
  .attr("rx", 15) // rounded corner
  .attr("ry", 15)
  .style("stroke", "#000000")
  .style("stroke-width", "3")
  .on("click", function() {
    currColor = "#ff0000";
    
    svg.selectAll(".colorChoice")
      .style("stroke-width", "0");
    d3.select(this).style("stroke", "#000000");
    d3.select(this).style("stroke-width", "3");
  });

svg.append("rect")
  .attr("class", "colorChoice")
  .attr("width", 50)
  .attr("height", 50)
  .attr("fill", "yellow")
  .attr("x", 65)
  .attr("y", 5)
  .attr("rx", 15)
  .attr("ry", 15)
  .on("click", function() {
    currColor = "#00ff00";
    
    svg.selectAll(".colorChoice")
      .style("stroke-width", "0");
    
    d3.select(this).style("stroke", "#000000");
    d3.select(this).style("stroke-width", "3");

    

  });
  
svg.append("rect")
  .attr("class", "colorChoice")
  .attr("width", 50)
  .attr("height", 50)
  .attr("fill", "blue")
  .attr("x", 125)
  .attr("y", 5)
  .attr("rx", 15)
  .attr("ry", 15)
  .on("click", function() {
    currColor = "#0000ff";
    
    svg.selectAll(".colorChoice")
      .style("stroke-width", "0");
    d3.select(this).style("stroke", "#000000");
    d3.select(this).style("stroke-width", "3");
});

svg.append("rect")
  .attr("class", "colorChoice")
  .attr("width", 50)
  .attr("height", 50)
  .attr("fill", "white")
  .attr("x", 185)
  .attr("y", 5)
  .attr("rx", 15) // rounded corner
  .attr("ry", 15)
  .on("click", function() {
    currColor = "#000000";
    
    svg.selectAll(".colorChoice")
      .style("stroke-width", "0");
    d3.select(this).style("stroke", "#000000");
    d3.select(this).style("stroke-width", "3");
  });


d3.select("#time").property("value", 0);
d3.select("#graphChoice").property("selectedIndex", 0);
d3.select("#time").on("input", function() {
  walk(+this.value);
});


var time = 0;
var initialNodeisClicked = false;

loadGraph("data/example1.json");

function getMaxOfArray(numArray) {
  return Math.max.apply(null, numArray);
}

function sumArray(numArray) {
  var sum = 0;
  for(var i = 0; i <numArray.length; i++)
    sum += numArray[i];
  return sum;
}

function sumLineArray2D(tab2D, line){
        var sum = 0;
        for(var i = 0; i < nbColor; i++){
                sum += tab2D[i][line];
        }
        return sum;
}

function walk(newTime) {
  
  time = newTime;
  
  d3.select("#time-value").text(time);
  d3.select("#time").property("value", time);


  var Xn = [];
  for( var i = 0; i < nbColor; i++) {
    Xn[i] = math.multiply(graph.X0[i], math.pow(graph.P, time));
  }
  
  for(var i = 0; i < nbColor; i++) {
    for(var j = 0; j < graph.nodes.length; j++) {
      graph.nodes[j].nbWalkers[i] = Xn[i].subset(math.index(j));
    }

  }
  
  update();
  
}

var automaticWalkInterval = null;  
function automaticWalk() {
  
  if(d3.select("#automaticWalkButton").classed("active")) {
    d3.select("#automaticWalkButton").classed("active", false);
    clearInterval(automaticWalkInterval);
  }
  else {
    d3.select("#automaticWalkButton").classed("active", true);
    automaticWalkInterval = setInterval(function () {walk(time+getSpeedWalk());}, 500);
  }
}


var speedWalk = 1;
function setSpeedWalk(sw) {
  d3.select("#setSpeedWalkButton" +speedWalk).classed("active", false);
  speedWalk = sw;
  d3.select("#setSpeedWalkButton" +speedWalk).classed("active", true);
}

function getSpeedWalk() {
  switch(speedWalk) { 
    case 1:
      return 1;
      break;
    case 2:
      return Math.round(graph.maxTime/50);
      break;
    case 3:
      return Math.round(graph.maxTime/20);
      break;
    default:
      return 1;
  }
  


}

function update() {

  if(node != null) {

    node
      .transition()
      .attr("r", function(d) {return (sumArray(d.nbWalkers)/nbWalkerTot)* 100 +5})
     // .attr("opacity", function(d) {return (sumArray(d.nbWalkers)/nbWalkerTot)*0.9+0.1 })
      .style("fill", changeColorNode) 
      .attr("title", function(d) { return d.nbWalkers[0] +"/"+d.nbWalkers[1] +"/"+d.nbWalkers[2] });
  }
  
  fillBarChart();

}

function reinitialization() {
  
  if(d3.select("#automaticWalkButton").classed("active"))
    automaticWalk(); // Stop the automatic walk
  if(d3.select("#startButton").classed("active"))
    start(); // Turn off the start button
  
  d3.select("#time").property("value", 0);
  time = 0;
  d3.select("#time-value").text(time);
  
  if(automaticWalkInterval != null) //Remove automatic walk
    clearInterval(automaticWalkInterval);
  
  clearBarChart();   

  nbWalkerTot = 0;
  if(graph != null) {
    for(var i = 0; i < nbColor; i++) {
      for(var j = 0; j < graph.nodes.length; j++) {

          graph.nodes[j].nbWalkers[i] = 0;
          graph.nodes[j].color = "white";
          graph.X0[i][j] = 0;
      }
    }
    
    node
      .transition()
        .attr("r", 15)
        .attr("title", function(d) { return d.nbWalkers[0] +"/"+d.nbWalkers[1] +"/"+d.nbWalkers[2] })
        .style("fill", "#ffffff")
  }

}

function start() {
 
 var buttonStart = d3.select("#startButton");
 
 if(buttonStart.classed("active")) {
    buttonStart.classed("active", false);
    buttonStart.property("textContent", "Start");
    
    d3.select("#walkButton").property("disabled", true);
    d3.select("#automaticWalkButton").property("disabled", true);
    d3.select("#showBarChartButton").property("disabled", true);
    d3.select("#time").property("disabled", true);
    
    d3.select("#setSpeedWalkButton1").property("disabled", true);
    d3.select("#setSpeedWalkButton2").property("disabled", true);
    d3.select("#setSpeedWalkButton3").property("disabled", true);
    
    d3.select("#setSpeedWalkButton1").classed("active", false);
    d3.select("#setSpeedWalkButton2").classed("active", false);
    d3.select("#setSpeedWalkButton3").classed("active", false);

    
    reinitialization();

  }
  else if(nbWalkerTot >= 100){
    buttonStart.classed("active", true);
    buttonStart.property("textContent", "Stop");
    
    
    d3.select("#walkButton").property("disabled", false);
    d3.select("#automaticWalkButton").property("disabled", false);
    d3.select("#showBarChartButton").property("disabled", false);
    d3.select("#time").property("disabled", false);
    
    d3.select("#setSpeedWalkButton1").property("disabled", false);
    d3.select("#setSpeedWalkButton2").property("disabled", false);
    d3.select("#setSpeedWalkButton3").property("disabled", false);
    
    d3.select("#setSpeedWalkButton1").classed("active", true);

  }
}


function changeColorNode(d) {
    
        
  var maxWalker = getMaxOfArray(d.nbWalkers);
        
  var rybColor = [];
  for(var i = 0; i < nbColor; i++) {
    if(maxWalker != 0)
      rybColor[i] = 255 * d.nbWalkers[i]/maxWalker; //
    else
      rybColor[i] = 0;
  }
  return "#" +(rybColorMixer.rybToRgb(rybColor, { hex: true}));
         
}

function initColorNode(element) {

  for(var i = 0; i < nbColor; i++) {
    element.nbWalkers[i] = 0;
    graph.X0[i][element.id] = 0;
  }
      
  switch(currColor) {
    case "#ff0000" :
          
      if(element.color == "white")
        nbWalkerTot+=100;                          

      element.color = "red"
      element.nbWalkers[0] = 100;
      graph.X0[0][element.id] = element.nbWalkers[0];
      break;
    
    case "#00ff00":
      if(element.color == "white")
        nbWalkerTot+=100;                          

      element.color = "yellow"
          
      element.nbWalkers[1] = 100;
      graph.X0[1][element.id] = element.nbWalkers[1];

      break;
    
    case "#0000ff" :
      if(element.color == "white")
        nbWalkerTot+=100;                          

      element.color = "blue"
      element.nbWalkers[2] = 100;
      graph.X0[2][element.id] = element.nbWalkers[2];

      break;
          
    case "#000000" :
        
      if(element.color != "white") {
        element.color = "white";
        nbWalkerTot -= 100;
      }
            
      break;
    
    default : break;
  }
      
  //element.color = currColor;            
                                
  node.transition()
    .style("fill", changeColorNode);  
        
  console.log(nbWalkerTot);
  
}     
</script>



